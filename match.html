<!DOCTYPE html>
<html lang="en">
<head>
    <title>Speed Dat(a)ing</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <style>
        .pie-slice path {
            stroke:#fff;
        }
        .dc-chart .selected path {
            stroke-width: 1;
            stroke:#fff;
        }
    </style>
</head>
<body>

    <div class='nav-header'>
        <img src='assets/logo.jpg'>
    </div>
    <div class='nav-bar'>
        <div class='nav-item'>
            <a class='nav-link' href='/'><p>Intro</p></a>
        </div>
        <div class='nav-item'>
            <a class='nav-link' href='/participants.html'><p>Meet our participants</p></a>
        </div>
        <div class='nav-item'>
            <a class='nav-link' href='/perception.html'><p>People Perception</p></a>
        </div>
        <div class='nav-item'>
            <a class='nav-link' href='/match.html'><p>Matching population</p></a>
        </div>
        <div class='nav-item'>
            <a class='nav-link' href='/machometre.html'><p>Machometre</p></a>
        </div>
    </div>

<div class="container" style="width:100%; margin-top: 55px; margin-bottom: 30px">
    <div class="row">
        <div class="col-sm-8">
            <div class="col-sm-6">
                <div class="row">
                    <div id="test" style="margin-left: 50px">
                        <strong style="font-size: 20px; margin-left: -35px">Men</strong>
                        <a class="reset" href="javascript:race_field.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="row" style="margin-top: 40px">
                    <div class="col-sm-6">
                        <div id="test3">
                            <strong style="font-size: 20px">Field of Study</strong>
                            <a class="reset" href="javascript:field.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div id="test2">
                            <strong style="font-size: 20px">Ethnicity</strong>
                            <a class="reset" href="javascript:race.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="row" style="margin-left: 15px">
                    <div id="attractive">
                        <strong style="font-size: 20px">Attractivity</strong>
                        <!--
                        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
                        -->
                        <a class="reset" href="javascript:attractive.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="row" style="margin-left: 15px">
                    <div id="sincere">
                        <strong style="font-size: 20px">Sincerity</strong>
                        <a class="reset" href="javascript:sincere.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="row" style="margin-left: 15px">
                    <div id="fun">
                        <strong style="font-size: 20px">Fun</strong>
                        <a class="reset" href="javascript:fun.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="row" style="margin-left: 15px">
                    <div>
                        <div class="dc-data-count", style="margin-left: 25px; margin-top: 20px; font-size: 16px;">
                            <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a
                                href="javascript:dc.filterAll(); dc.renderAll()">Reset All</a>
                        </div>
                    </div>
                </div>        
            </div>
        </div>
        <div class="col-sm-4">
            <div id="matches">
                <strong style="font-size: 20px;">Matches</strong>
                <a class="reset" href="javascript:matchesChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript">

var field = dc.rowChart("#test3");
var race = dc.rowChart("#test2");
var race_field = dc.sunburstChart("#test");
var attractive = dc.barChart("#attractive")
var sincere = dc.barChart("#sincere")
var fun = dc.barChart("#fun")
var datesCount = dc.dataCount('.dc-data-count');
var matchesChart = dc.bubbleChart('#matches');

race_dict = {
    0 : '',
    1 : 'Black',
    2 : 'European',
    3 : 'Latino',
    4 : 'Asian',
    5 : 'Native',
    6 : 'Other',
    7 : ''
}

field_dict = {
    0 : '',
    1 : 'Law',
    2 : 'Math',
    3 : 'Social Science',
    4 : 'Medical Science',
    5 : 'Engineering',
    6 : 'English',
    7 : 'History',
    8 : 'Business',
    9 : 'Education',
    10 : 'Biological Sciences',
    11 : 'Social Work',
    12 : 'Undergrade',
    13 : 'Political Science',
    14 : 'Film',
    15 : 'Fine Arts',
    16 : 'Languages',
    17 : 'Architecture',
    18 : 'other',
    19 : '',
}

d3.csv("data/new_dataset.csv").then(function(dates) {

    dates.forEach(function (d) {
        d.attr1_1 = +d.attr1_1;
        d.sinc1_1 = +d.sinc1_1;
        d.fun1_1 = +d.fun1_1;
        d.match = +d.match;
    });

    var ndx = crossfilter(dates)
    
    var all_data_count = ndx.groupAll()

    var all = ndx.groupAll().reduce(
        function reduceAdd(p, d) {
            p.count++;
            if(d.match === 1){
                p.matches_count++
            }
            return p;
        },

        function reduceRemove(p, d) {
            p.count--;
            if(d.match === 1){
                p.matches_count--
            }
            return p;
        },

        function reduceInitial() {
            return {matches_count: 0,
                    count: 0};
        }
    )

    menDimension = ndx.dimension(function (d) {
        return [d.race, d.field_cd];
    });

    var menSumGroup = menDimension.group().reduce(
        function reduceAdd(p, d) {
            if(d.iid in p.ids){
                p.ids[d.iid] += 1
            }
            else{
                p.ids[d.iid] = 1;
                p.id_count++;
            }
            return p;
        },

        function reduceRemove(p, d) {
            p.ids[d.iid]--;
            if(p.ids[d.iid] === 0){
                delete p.ids[d.iid];
                p.id_count--;
            }
            return p;
        },

        function reduceInitial() {
            return {ids: {},
                    id_count: 0};
        }
    )

    womenDimension = ndx.dimension(function (d) {
        return [d.race_p, d.field_cd_p];
    });

    var womenGroup = womenDimension.group().reduce(
        function reduceAdd(p, d) {
            if(d.match === 1){
                p.matches_count++
            }
            return p;
        },

        function reduceRemove(p, d) {
            if(d.match === 1){
                p.matches_count--
            }
            return p;
        },

        function reduceInitial() {
            return {matches_count: 0};
        }
    )

    var raceDimension = ndx.dimension(function (d) {
        return d.race;
    });
    
    var raceSumGroup = raceDimension.group().reduce(
        function reduceAdd(p, d) {
            if(d.iid in p.ids){
                p.ids[d.iid] += 1
            }
            else{
                p.ids[d.iid] = 1;
                p.id_count++;
            }
            return p;
        },

        function reduceRemove(p, d) {
            p.ids[d.iid]--;
            if(p.ids[d.iid] === 0){
                delete p.ids[d.iid];
                p.id_count--;
            }
            return p;
        },

        function reduceInitial() {
            return {ids: {},
                    id_count: 0};
        }
    )

    var fieldDimension = ndx.dimension(function (d) {
        return d.field_cd;
    });

    var fieldSumGroup = fieldDimension.group().reduce(
        function reduceAdd(p, d) {
            if(d.iid in p.ids){
                p.ids[d.iid] += 1
            }
            else{
                p.ids[d.iid] = 1;
                p.id_count++;
            }
            return p;
        },

        function reduceRemove(p, d) {
            p.ids[d.iid]--;
            if(p.ids[d.iid] === 0){
                delete p.ids[d.iid];
                p.id_count--;
            }
            return p;
        },

        function reduceInitial() {
            return {ids: {},
                    id_count: 0};
        }
    )

    var attractiveDimension = ndx.dimension(function (d) {
        return d.attr1_1;
    });

    var attractiveSumGroup = attractiveDimension.group().reduce(
        function reduceAdd(p, d) {
            if(d.iid in p.ids){
                p.ids[d.iid] += 1
            }
            else{
                p.ids[d.iid] = 1;
                p.id_count++;
            }
            return p;
        },

        function reduceRemove(p, d) {
            p.ids[d.iid]--;
            if(p.ids[d.iid] === 0){
                delete p.ids[d.iid];
                p.id_count--;
            }
            return p;
        },

        function reduceInitial() {
            return {ids: {},
                    id_count: 0};
        }
    )

    var sincereDimension = ndx.dimension(function (d) {
        return d.sinc1_1;
    });

    var sincereSumGroup = sincereDimension.group().reduce(
        function reduceAdd(p, d) {
            if(d.iid in p.ids){
                p.ids[d.iid] += 1
            }
            else{
                p.ids[d.iid] = 1;
                p.id_count++;
            }
            return p;
        },

        function reduceRemove(p, d) {
            p.ids[d.iid]--;
            if(p.ids[d.iid] === 0){
                delete p.ids[d.iid];
                p.id_count--;
            }
            return p;
        },

        function reduceInitial() {
            return {ids: {},
                    id_count: 0};
        }
    )

    var funDimension = ndx.dimension(function (d) {
        return d.fun1_1;
    });

    var funSumGroup = funDimension.group().reduce(
        function reduceAdd(p, d) {
            if(d.iid in p.ids){
                p.ids[d.iid] += 1
            }
            else{
                p.ids[d.iid] = 1;
                p.id_count++;
            }
            return p;
        },

        function reduceRemove(p, d) {
            p.ids[d.iid]--;
            if(p.ids[d.iid] === 0){
                delete p.ids[d.iid];
                p.id_count--;
            }
            return p;
        },

        function reduceInitial() {
            return {ids: {},
                    id_count: 0};
        }
    )

    histogramm_width = 635
    histogramm_height = 278

    attractive
        .width(histogramm_width)
        .height(histogramm_height)
        .round(dc.round.floor)
        .alwaysUseRounding(true)
        .x(d3.scaleLinear().domain([0, 100]))
        .dimension(attractiveDimension)
        .group(attractiveSumGroup)
        .valueAccessor(function (d) {
            return d.value.id_count;
        })
        .elasticY(true)
        .renderHorizontalGridLines(true)
        .renderVerticalGridLines(true)
        .yAxis().ticks(5)

    attractive.margins().top = 30

    sincere
        .width(histogramm_width)
        .height(histogramm_height)
        .x(d3.scaleLinear().domain([0, 100]))
        .dimension(sincereDimension)
        .group(sincereSumGroup)
        .valueAccessor(function (d) {
            return d.value.id_count;
        })
        .elasticY(true)
        .renderHorizontalGridLines(true)
        .renderVerticalGridLines(true)
        .yAxis().ticks(5)

    sincere.margins().top = 30
    
    fun
        .width(histogramm_width)
        .height(histogramm_height)
        .x(d3.scaleLinear().domain([0, 100]))
        .dimension(funDimension)
        .group(funSumGroup)
        .valueAccessor(function (d) {
            return d.value.id_count;
        })
        .elasticY(true)
        .renderHorizontalGridLines(true)
        .renderVerticalGridLines(true)
        .yAxis().ticks(5)

    fun.margins().top = 30

    field
        .width(350)
        .height(400)
        .dimension(fieldDimension)
        .group(fieldSumGroup)
        .valueAccessor(function (d) {
            return d.value.id_count;
        })
        .elasticX(true)
        .ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#e86d30', '#fd8d3c', '#fdae6b',
                        '#fdd0a2', '#31a354', '#74c476', '#a1d99b', '#c7e9c0', '#756bb1', '#9e9ac8', 
                        '#bcbddc', '#dadaeb', '#636363', '#969696'])

    field.margins().top = 20

    race
        .width(300)
        .height(350)
        .dimension(raceDimension)
        .group(raceSumGroup)
        .valueAccessor(function (d) {
            return d.value.id_count;
        })
        .elasticX(true)
        //.ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#e6550d'])
        .ordinalColors(['#fc94fa', '#fc9494', '#acfc94', '#64e585', '#ffe65b'])

    race.margins().top = 80

    race_field
        .width(480)
        .height(480)
        .innerRadius(100)
        .dimension(menDimension)
        .group(menSumGroup)
        .valueAccessor(function (d) {
            return d.value.id_count;
        })
        //.ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#e6550d'])
        .ordinalColors(['#fc94fa', '#fc9494', '#acfc94', '#64e585', '#ffe65b', '#6baed6', '#9ecae1', '#c6dbef', '#e86d30', '#fd8d3c', '#fdae6b',
                        '#a1d99b', '#c7e9c0', '#9e9ac8', '#bcbddc', '#969696', '#fdd0a2', '#31a354', '#74c476', '#756bb1', '#dadaeb', '#636363',
                        '#3182bd'])

    datesCount
        .crossfilter(ndx)
        .groupAll(all_data_count)
        .html({
            //some: '<strong>%filter-count</strong> "dates" sélectionnées sur <strong>%total-count</strong>' +
            //    ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();matchesChart.translate(80)\'>Reset All</a>',
            some: '<strong>%filter-count</strong> "dates" sélectionnées sur <strong>%total-count</strong>' +
                ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();matchesChart.translate(80)\'>Reset All</a>',
            all: 'All dates selected. Click on graphs to apply filters'
        });

    matchesChart
        .width(550)
        //.height(950)
        .height(970)
        .dimension(womenDimension)
        .group(womenGroup)
        .colors(d3.schemeRdYlGn[9])
        .keyAccessor(function (p) {
            return p.key[0];
        })
        .valueAccessor(function (p) {
            return p.key[1];
        })
        .radiusValueAccessor(function (p) {
            //console.log(Math.round(8*p.value.matches_count/all.value()['count']*100))
            return Math.round(8*p.value.matches_count/all.value()['count']*100);
        })
        .maxBubbleRelativeSize(1)
        .x(d3.scaleLinear().domain([0, 7]))
        .y(d3.scaleLinear().domain([0, 17]))
        .r(d3.scaleLinear().domain([0, 300]))
        .renderHorizontalGridLines(true)
        .renderVerticalGridLines(true)
        .xAxisLabel('')
        .renderLabel(false)
        .yAxisLabel('')
        .title(function (p) {
            return p.value.matches_count;
        })
        .onClick = function (datum) {
        };

    matchesChart.xAxis().ticks(8)
    matchesChart.xAxis().tickFormat(function (v) {
            return race_dict[v];
        });
    matchesChart.yAxis().ticks(18)
    matchesChart.yAxis().tickFormat(function (v) {
            return field_dict[v];
        });
    matchesChart.margins().top = 30  

    //matchesChart.renderlet(function (chart) {
        // rotate x-axis labels
    //    chart.selectAll('g.y text')
    //    .attr('transform', 'translate(50,10) rotate(315)')
    //})

    dc.renderAll();
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    matchesChart.translate = async function (x){
        
        await sleep(10);

        matchesChart
            .select('.axis.y') 
            .attr("text-anchor", "end")
            .selectAll("text")
            .attr("transform", "translate(-5,-5) rotate(-45)")
        
        console.log("translate")    
        matchesChart
            .select('.grid-line.horizontal')
            .attr("transform", "translate(" + x + ",30)")
        matchesChart
            .select('.grid-line.vertical')
            .attr("transform", "translate(" + x + ",30)")
        matchesChart
            .select('.chart-body')
            .attr("transform", "translate(" + x + ",30)")
        matchesChart
            .select('.axis.x')
            //.attr("transform", "translate(" + x + ",908)")
            .attr("transform", "translate(" + x + ",928)")
        matchesChart
            .select('.axis.y')
            .attr("transform", "translate(" + x + ",30)")
    }

    matchesChart.all = all
    
    matchesChart.translate(82);

});

</script>

</body>
</html>
